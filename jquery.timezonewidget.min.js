"use strict";

(function(e){e.fn.timezoneWidget=function(t){var n=e.extend({},e.fn.timezoneWidget.defaults,t);n.tz=n.data;var i={elem:null,tz:[],regions:[],timezones:[],regSelect:null,tzSelect:null,selectedRegion:-1,selectedTimezone:"",userClickedRegion:!1,draw:function(){if(e("#"+n.tzField).length>0&&(i.selectedTimezone=e("#"+n.tzField).val(),i.selectedRegion=e("#"+n.regionField).val()),e("#"+n.regionField).length&&i.selectedRegion.length>0)i.selectedRegion=parseInt(i.selectedRegion);else if(n.guessUserTimezone){var t=new Date,l=t+"";l=l.split(/GMT/),l.length>0&&(l=l[1].split(/ /),l=l[0],5==l.length&&(l="UTC"+l.substring(0,3)+":"+l.substring(3,6)),9==l.length?e.each(n.tz,function(e,t){var n=i.findOffset(t,l);if(n)return!1}):n.defaultRegion&&(i.selectedRegion=n.defaultRegion))}else n.defaultRegion&&(i.selectedRegion=n.defaultRegion);i.regSelect=e("<select/>").attr("size",n.tz.length).addClass("tz_region_select"),e.each(n.tz,function(t,n){i.regSelect.append(e("<option/>").val(n.id).text(n.label))}),i.elem.append(i.regSelect),i.elem.append(e("<div/>").addClass("tz_timezone_container")),i.regSelect.change(function(){i.selectedRegion=parseInt(e(this).val()),i.elem.find(".tz_timezone_container").html(""),i.tzSelect=e("<select data-placeholder='Select a timezone...'/>").append("<option value=''/>").addClass("tz_timezone_select"),i.getZones(function(t,n){var l=t.split(/\//);i.tzSelect.append(e("<option/>").val(t).text(n+" "+l[1].replace(/_/g," ")+(l.length>2?"/"+l[2]:"")))}),i.selectedTimezone.length>0&&i.tzSelect.val(i.selectedTimezone),i.elem.find(".tz_timezone_container").html(i.tzSelect),i.elem.find(".tz_timezone_select").chosen(),i.elem.find(".tz_timezone_select").change(function(){i.selectedTimezone=e(this).val(),e("#"+n.tzField).val(i.selectedTimezone),e("#"+n.regionField).val(i.selectedRegion),n.onTimezoneSelect(i.selectedRegion,i.selectedTimezone)}),i.selectedTimezone.length>0&&null!=i.tzSelect.val()?i.tzSelect.trigger("change"):n.onRegionSelect(i.selectedRegion)}),i.selectedRegion>0&&(i.regSelect.val(i.selectedRegion),i.regSelect.change(),i.regSelect.hover(function(){i.userClickedRegion=!0}),i.regSelect.focus(function(){i.userClickedRegion||(i.elem.find(".tz_timezone_select+div").trigger("mousedown"),i.userClickedRegion=!1)}))},findOffset:function(t,n){var l=!1;return e.each(t.timezones,function(o,c){e.each(c.labels,function(e,o){if(c.offsetLabel.indexOf(n)!=-1)return i.selectedRegion=t.id,i.selectedTimezone=o,l=!0,!1})}),l},getZones:function(t){e.each(n.tz,function(n,l){if(l.id==i.selectedRegion)return e.each(l.timezones,function(n,i){e.each(i.labels,function(e,n){t(n,i.offsetLabel)})}),!1})}};return i.elem=this,this.addClass("tzwidget"),i.draw(),this},e.fn.timezoneWidget.defaults={regionField:"tz_region",tzField:"timezone",data:null,defaultRegion:1024,guessUserTimezone:!1,onRegionSelect:function(){},onTimezoneSelect:function(){}}}(jQuery));